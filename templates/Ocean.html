<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/Ocean.css">
    <title>Ocean Drift Bottles</title>
</head>
<body>
    
    <main class="ocean-background">
        <div class="ui-block">
            <!-- Message Display -->
            <div class="message-display">
                <textarea id="message-textbox" placeholder="Enter your message here..."></textarea>
            </div>
            <div class="ui-block-bottom">
                <button id="done-button">Done</button>
                <!-- Buttons -->
                <div class="button-container">
                    <button id="get-button">Get</button>
                    <button id="drop-button">Drop</button>
                    <button id="dropped-bottles-button">Dropped Bottles</button>
                </div>
            </div>
        </div>
            <!-- Dropped Bottles History -->
            <div class="dropped-bottles-history">
                <!-- Display dropped bottles and replies here -->
            </div>
    </main>
    <div id = "back-btn">
        <img src="../static/images/lighthouse-svgrepo-com.svg" alt="back button">
    </div>
    <div id="shoreline">
    </div>
</body>
<script src="script.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    //Axios interceptor to attach the JWT to every request
    console.log("Setting up interceptors...");
    axios.interceptors.request.use(function (config) {
        const token = localStorage.getItem('access_token');
        console.log("Interceptor triggered with token:", token);
        if (token) {
            config.headers.Authorization = 'Bearer ' + token;
        }
        return config;
    }, function (error) {
        return Promise.reject(error);
    });
</script>
<script>

    // This is a load of garbage, I'll fix it up soon.

    // var shoreline = document.getElementById("shoreline")
    // var bottles = 0;

    // document.getElementById("get-button").addEventListener("click", function () {
    //     var bottle = document.createElement("div");
    //     bottle.classList.add("bottle");
    //     bottle.innerHTML = "<img src=\"../static/images/bottle.png\" alt=\"bottle\" class=\"bottle-icon\">"
    //     bottles++;

    //     axios({
    //         url: '/api/bottlemessages',
    //         method: 'GET',
    //     }).then(result => {
    //         console.log(result.data);
    //         message = result.data.message;
    //         shoreline.prepend(bottle);
    //     }).catch(error => {
    //         console.error("Error fetching user info: ", error);
    //         message = "the note is blank. . ."
    //         shoreline.appendChild(bottle);
    //     });
        
    //     bottle.addEventListener("click", function() {
    //             console.log("clicked");
    //             alert(message);
    //             bottle.remove()
    //     });

    //     // todo:
    //     // - move from alerts to visuals
    //     // - allow user to drop bottles
    //     // - fix issues
    // });
    document.getElementById("get-button").addEventListener("click", function () {
        axios({
            url: '/api/bottlemessages',
            method: 'GET',
        }).then(result => {
            console.log(result.data);
            let message_content = result.data.message_content;
            let bottle = createBottle(message_content);
            shoreline.prepend(bottle);
        }).catch(error => {
            console.error("Error fetching message: ", error);
            let bottle = createBottle("The note is blank...");
            shoreline.appendChild(bottle);
        });
    });

    function createBottle(message) {
        var bottle = document.createElement("div");
        bottle.classList.add("bottle");
        bottle.innerHTML = "<img src=\"../static/images/bottle.png\" alt=\"bottle\" class=\"bottle-icon\">";

        bottle.addEventListener("click", function() {
            console.log("Bottle clicked with message: ", message);
            alert(message);
            bottle.remove();
        });
        return bottle;
    }
</script>
<script>
    document.getElementById("drop-button").addEventListener("click", function() {
        var messageContent = document.getElementById("message-textbox").value;
        axios.post('/api/bottlemessages/send', {
            message: messageContent
        }).then(response => {
            console.log(response.data);
            alert("Message dropped successfully!");
        }).catch(error => {
            console.error("Error sending message: ", error);
            alert("Failed to drop the message.");
        });
    });
</script>

<script>
    document.getElementById("back-btn").addEventListener("click", function() {
            window.location.href= '/homepage';
    });
</script>

</html>
